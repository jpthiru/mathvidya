<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Register - Mathvidya | CBSE Math Practice Platform</title>
  <meta name="description" content="Create your Mathvidya account - Practice CBSE board exam questions online with expert teacher evaluation.">
  <meta name="robots" content="noindex, nofollow">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Font Awesome 6 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- Main Stylesheet -->
  <link rel="stylesheet" href="css/main.css">

  <style>
    /* Register Page Specific Styles */
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--gradient-primary);
      overflow-x: hidden;
      padding: 2rem 0;
    }

    .register-container {
      display: flex;
      width: 95%;
      max-width: 1100px;
      min-height: 700px;
      background: white;
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      overflow: hidden;
      animation: scaleIn 0.5s ease-out;
    }

    /* Left Panel - Branding */
    .register-left {
      flex: 0 0 35%;
      background: var(--gradient-primary);
      color: white;
      padding: 2.5rem;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .register-left::before {
      content: '';
      position: absolute;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
      background-size: 30px 30px;
      animation: float 20s linear infinite;
    }

    @keyframes float {
      0% { transform: translate(0, 0); }
      100% { transform: translate(50px, 50px); }
    }

    .register-logo {
      position: relative;
      z-index: 1;
      font-size: 2.5rem;
      margin-bottom: 1rem;
    }

    .register-brand {
      position: relative;
      z-index: 1;
    }

    .register-brand h1 {
      font-size: var(--text-3xl);
      margin-bottom: 0.75rem;
      color: white;
    }

    .register-brand p {
      font-size: var(--text-base);
      opacity: 0.9;
    }

    .register-features {
      position: relative;
      z-index: 1;
      margin-top: 1.5rem;
      text-align: left;
    }

    .register-features li {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
      font-size: var(--text-sm);
    }

    .register-features i {
      color: rgba(255, 255, 255, 0.8);
    }

    /* Right Panel - Form */
    .register-right {
      flex: 1;
      padding: 2.5rem;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      overflow-y: auto;
    }

    .register-header {
      margin-bottom: 1.5rem;
    }

    .register-header h2 {
      font-size: var(--text-2xl);
      margin-bottom: 0.25rem;
      color: var(--color-gray-800);
    }

    .register-header p {
      color: var(--color-gray-600);
      font-size: var(--text-sm);
    }

    /* Form */
    .register-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .form-section {
      background: var(--color-gray-50);
      padding: 1.25rem;
      border-radius: var(--radius-lg);
      margin-bottom: 0.5rem;
    }

    .form-section-title {
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--color-gray-700);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .form-section-title i {
      color: var(--color-primary);
    }

    .form-group {
      position: relative;
    }

    .form-group label {
      display: block;
      font-size: var(--text-xs);
      font-weight: 500;
      color: var(--color-gray-600);
      margin-bottom: 0.35rem;
    }

    .form-icon {
      position: absolute;
      left: 0.85rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--color-gray-400);
      pointer-events: none;
      font-size: 0.9rem;
    }

    .form-input-icon {
      padding-left: 2.5rem;
    }

    .form-input {
      height: 42px;
      font-size: var(--text-sm);
    }

    .password-toggle {
      position: absolute;
      right: 0.85rem;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--color-gray-400);
      cursor: pointer;
      transition: color var(--transition-fast);
    }

    .password-toggle:hover {
      color: var(--color-gray-600);
    }

    /* Class Selection */
    .class-selector {
      display: flex;
      gap: 0.75rem;
    }

    .class-btn {
      flex: 1;
      padding: 0.6rem 1rem;
      background: white;
      border: 2px solid var(--color-gray-300);
      border-radius: var(--radius-md);
      font-weight: 600;
      color: var(--color-gray-600);
      cursor: pointer;
      transition: all 0.2s;
      font-size: var(--text-sm);
    }

    .class-btn:hover {
      border-color: var(--color-primary);
    }

    .class-btn.active {
      background: var(--color-primary);
      border-color: var(--color-primary);
      color: white;
    }

    /* Terms Section */
    .terms-section {
      background: var(--color-gray-50);
      padding: 1rem;
      border-radius: var(--radius-md);
      margin-top: 0.5rem;
    }

    .terms-checkbox {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      cursor: pointer;
    }

    .terms-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin-top: 2px;
      cursor: pointer;
      accent-color: var(--color-primary);
    }

    .terms-checkbox span {
      font-size: var(--text-sm);
      color: var(--color-gray-600);
      line-height: 1.5;
    }

    .terms-checkbox a {
      color: var(--color-primary);
      font-weight: 500;
    }

    .terms-error {
      color: var(--color-danger);
      font-size: var(--text-xs);
      margin-top: 0.5rem;
    }

    .register-footer {
      margin-top: 1.5rem;
      text-align: center;
      font-size: var(--text-sm);
      color: var(--color-gray-600);
    }

    .register-footer a {
      color: var(--color-primary);
      font-weight: 600;
    }

    .back-home {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.75rem;
      color: var(--color-gray-600);
      font-size: var(--text-sm);
    }

    /* Verification Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .verification-modal {
      background: white;
      border-radius: var(--radius-xl);
      padding: 2.5rem;
      width: 90%;
      max-width: 420px;
      text-align: center;
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }

    .modal-overlay.active .verification-modal {
      transform: scale(1);
    }

    .verification-icon {
      width: 80px;
      height: 80px;
      background: var(--gradient-primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1.5rem;
    }

    .verification-icon i {
      font-size: 2rem;
      color: white;
    }

    .verification-title {
      font-size: var(--text-xl);
      font-weight: 600;
      color: var(--color-gray-800);
      margin-bottom: 0.5rem;
    }

    .verification-subtitle {
      color: var(--color-gray-600);
      font-size: var(--text-sm);
      margin-bottom: 1.5rem;
    }

    .verification-email {
      font-weight: 600;
      color: var(--color-primary);
    }

    .code-input-container {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      margin-bottom: 1.5rem;
    }

    .code-input {
      width: 50px;
      height: 60px;
      text-align: center;
      font-size: 1.5rem;
      font-weight: 700;
      border: 2px solid var(--color-gray-300);
      border-radius: var(--radius-md);
      transition: all 0.2s;
    }

    .code-input:focus {
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
      outline: none;
    }

    .code-input.error {
      border-color: var(--color-danger);
    }

    .code-input.success {
      border-color: var(--color-success);
      background: rgba(16, 185, 129, 0.05);
    }

    .verification-timer {
      color: var(--color-gray-500);
      font-size: var(--text-sm);
      margin-bottom: 1rem;
    }

    .verification-timer span {
      font-weight: 600;
      color: var(--color-primary);
    }

    .resend-link {
      color: var(--color-primary);
      font-weight: 500;
      cursor: pointer;
      font-size: var(--text-sm);
    }

    .resend-link:hover {
      text-decoration: underline;
    }

    .resend-link.disabled {
      color: var(--color-gray-400);
      cursor: not-allowed;
    }

    .verification-error {
      color: var(--color-danger);
      font-size: var(--text-sm);
      margin-top: 1rem;
    }

    .verification-success {
      color: var(--color-success);
      font-size: var(--text-sm);
      margin-top: 1rem;
    }

    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      font-size: 1.25rem;
      color: var(--color-gray-400);
      cursor: pointer;
      padding: 0.5rem;
    }

    .modal-close:hover {
      color: var(--color-gray-600);
    }

    .verification-modal {
      position: relative;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .register-container {
        flex-direction: column;
        max-height: none;
      }

      .register-left {
        padding: 2rem;
        min-height: 180px;
      }

      .register-features {
        display: none;
      }

      .register-right {
        padding: 2rem;
        max-height: none;
      }

      .form-row {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 1rem 0;
      }

      .register-container {
        width: 100%;
        border-radius: 0;
      }

      .register-left {
        padding: 1.5rem;
      }

      .register-right {
        padding: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="register-container">
    <!-- Left Panel - Branding -->
    <div class="register-left">
      <div class="register-logo">
        <i class="fas fa-calculator"></i>
      </div>
      <div class="register-brand">
        <h1>Mathvidya</h1>
        <p>Start Your Journey to Excellence</p>
      </div>
      <ul class="register-features" style="list-style: none; padding: 0;">
        <li><i class="fas fa-check-circle"></i> Board exam aligned practice</li>
        <li><i class="fas fa-check-circle"></i> Expert teacher evaluation</li>
        <li><i class="fas fa-check-circle"></i> Performance analytics</li>
        <li><i class="fas fa-check-circle"></i> Predicted board scores</li>
      </ul>
    </div>

    <!-- Right Panel - Form -->
    <div class="register-right">
      <div class="register-header">
        <h2>Create Account</h2>
        <p>Register as a student to get started</p>
      </div>

      <!-- Register Form -->
      <form class="register-form" id="registerForm">
        <!-- Student Information -->
        <div class="form-section">
          <div class="form-section-title">
            <i class="fas fa-user-graduate"></i>
            Student Information
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>First Name *</label>
              <input type="text" class="form-input" id="firstName" placeholder="First name" required>
              <span class="form-error" id="firstNameError"></span>
            </div>
            <div class="form-group">
              <label>Last Name *</label>
              <input type="text" class="form-input" id="lastName" placeholder="Last name" required>
              <span class="form-error" id="lastNameError"></span>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Class *</label>
              <div class="class-selector">
                <button type="button" class="class-btn" data-class="IX">Class IX</button>
                <button type="button" class="class-btn" data-class="X">Class X</button>
                <button type="button" class="class-btn" data-class="XI">Class XI</button>
                <button type="button" class="class-btn active" data-class="XII">Class XII</button>
              </div>
            </div>
            <div class="form-group">
              <label>Phone *</label>
              <input type="tel" class="form-input" id="studentPhone" placeholder="9876543210" required>
              <span class="form-error" id="studentPhoneError"></span>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Email *</label>
              <input type="email" class="form-input" id="studentEmail" placeholder="student@email.com" required>
              <span class="form-error" id="studentEmailError"></span>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Password *</label>
              <div style="position: relative;">
                <input type="password" class="form-input" id="password" placeholder="Min. 8 characters" required>
                <button type="button" class="password-toggle" id="passwordToggle">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
              <span class="form-error" id="passwordError"></span>
            </div>
            <div class="form-group">
              <label>Confirm Password *</label>
              <div style="position: relative;">
                <input type="password" class="form-input" id="confirmPassword" placeholder="Confirm password" required>
                <button type="button" class="password-toggle" id="confirmPasswordToggle">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
              <span class="form-error" id="confirmPasswordError"></span>
            </div>
          </div>
        </div>

        <!-- Parent/Guardian Information -->
        <div class="form-section">
          <div class="form-section-title">
            <i class="fas fa-user-friends"></i>
            Parent/Guardian Information (Required)
          </div>

          <div class="form-group" style="margin-bottom: 1rem;">
            <label>Parent/Guardian Name *</label>
            <input type="text" class="form-input" id="parentName" placeholder="Enter parent/guardian name" required>
            <span class="form-error" id="parentNameError"></span>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Parent Email *</label>
              <input type="email" class="form-input" id="parentEmail" placeholder="parent@email.com" required>
              <span class="form-error" id="parentEmailError"></span>
            </div>
            <div class="form-group">
              <label>Parent Phone *</label>
              <input type="tel" class="form-input" id="parentPhone" placeholder="9876543210" required>
              <span class="form-error" id="parentPhoneError"></span>
            </div>
          </div>
        </div>

        <!-- Promo Code (Optional) -->
        <div class="form-section" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
          <div class="form-section-title">
            <i class="fas fa-gift"></i>
            Have a Promo Code? (Optional)
          </div>

          <div class="form-row">
            <div class="form-group" style="flex: 1;">
              <label>Promo Code</label>
              <div style="display: flex; gap: 0.5rem;">
                <input type="text" class="form-input" id="promoCode" placeholder="Enter promo code" style="flex: 1; text-transform: uppercase;">
                <button type="button" class="btn btn-secondary" id="validatePromoBtn" style="white-space: nowrap;">
                  <i class="fas fa-check"></i> Apply
                </button>
              </div>
              <span class="form-error" id="promoCodeError"></span>
            </div>
          </div>

          <!-- Promo code result display -->
          <div id="promoCodeResult" style="display: none; margin-top: 0.75rem; padding: 0.75rem; border-radius: var(--radius-md); background: white;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <i class="fas fa-check-circle" style="color: var(--color-success);"></i>
              <span id="promoCodeMessage" style="font-weight: 500; color: var(--color-success);"></span>
            </div>
          </div>
        </div>

        <!-- Terms Acceptance -->
        <div class="terms-section">
          <label class="terms-checkbox">
            <input type="checkbox" id="acceptTerms" required>
            <span>
              I agree to the <a href="terms-and-conditions.html" target="_blank">Terms and Conditions</a>
              and <a href="privacy-policy.html" target="_blank">Privacy Policy</a>
            </span>
          </label>
          <div class="terms-error" id="termsError"></div>
        </div>

        <button type="submit" class="btn btn-primary btn-lg w-full" id="registerBtn">
          <i class="fas fa-user-plus"></i>
          Create Account
        </button>
      </form>

      <div class="register-footer">
        <p>Already have an account? <a href="login.html">Sign in</a></p>
        <a href="index.html" class="back-home">
          <i class="fas fa-arrow-left"></i>
          Back to Home
        </a>
      </div>
    </div>
  </div>

  <!-- Email Verification Modal -->
  <div class="modal-overlay" id="verificationModal">
    <div class="verification-modal">
      <button class="modal-close" id="closeModal">
        <i class="fas fa-times"></i>
      </button>

      <div class="verification-icon">
        <i class="fas fa-envelope"></i>
      </div>

      <h3 class="verification-title">Verify Your Email</h3>
      <p class="verification-subtitle">
        We've sent a 6-digit code to<br>
        <span class="verification-email" id="verificationEmail"></span>
      </p>

      <div class="code-input-container">
        <input type="text" class="code-input" maxlength="1" data-index="0" inputmode="numeric" pattern="[0-9]">
        <input type="text" class="code-input" maxlength="1" data-index="1" inputmode="numeric" pattern="[0-9]">
        <input type="text" class="code-input" maxlength="1" data-index="2" inputmode="numeric" pattern="[0-9]">
        <input type="text" class="code-input" maxlength="1" data-index="3" inputmode="numeric" pattern="[0-9]">
        <input type="text" class="code-input" maxlength="1" data-index="4" inputmode="numeric" pattern="[0-9]">
        <input type="text" class="code-input" maxlength="1" data-index="5" inputmode="numeric" pattern="[0-9]">
      </div>

      <div class="verification-timer">
        Code expires in <span id="timerDisplay">15:00</span>
      </div>

      <p>
        Didn't receive the code?
        <span class="resend-link" id="resendCode">Resend Code</span>
      </p>

      <div class="verification-error" id="verificationError" style="display: none;"></div>
      <div class="verification-success" id="verificationSuccess" style="display: none;"></div>

      <button class="btn btn-primary btn-lg w-full" id="verifyBtn" style="margin-top: 1.5rem;">
        <i class="fas fa-check"></i>
        Verify & Create Account
      </button>
    </div>
  </div>

  <!-- Scripts -->
  <script src="js/api.js"></script>
  <script src="js/main.js"></script>
  <script src="js/analytics.js"></script>
  <script>
    // Class selection
    let selectedClass = 'XII';
    const classBtns = document.querySelectorAll('.class-btn');

    classBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        classBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedClass = btn.dataset.class;
      });
    });

    // Password toggles
    function setupPasswordToggle(inputId, toggleId) {
      const input = document.getElementById(inputId);
      const toggle = document.getElementById(toggleId);

      toggle.addEventListener('click', () => {
        const type = input.type === 'password' ? 'text' : 'password';
        input.type = type;
        toggle.querySelector('i').classList.toggle('fa-eye');
        toggle.querySelector('i').classList.toggle('fa-eye-slash');
      });
    }

    setupPasswordToggle('password', 'passwordToggle');
    setupPasswordToggle('confirmPassword', 'confirmPasswordToggle');

    // Form validation and submission
    const registerForm = document.getElementById('registerForm');
    const registerBtn = document.getElementById('registerBtn');

    // Validation helpers
    function validatePhone(phone) {
      return /^[6-9]\d{9}$/.test(phone.replace(/\s/g, ''));
    }

    function showError(inputId, errorId, message) {
      const input = document.getElementById(inputId);
      const error = document.getElementById(errorId);
      if (input) input.classList.add('error');
      if (error) error.textContent = message;
    }

    function clearError(inputId, errorId) {
      const input = document.getElementById(inputId);
      const error = document.getElementById(errorId);
      if (input) input.classList.remove('error');
      if (error) error.textContent = '';
    }

    // Clear errors on input - map field IDs to their error IDs
    const fieldErrorMap = {
      'firstName': 'firstNameError',
      'lastName': 'lastNameError',
      'studentEmail': 'studentEmailError',
      'studentPhone': 'studentPhoneError',
      'password': 'passwordError',
      'confirmPassword': 'confirmPasswordError',
      'parentName': 'parentNameError',
      'parentEmail': 'parentEmailError',
      'parentPhone': 'parentPhoneError'
    };

    Object.entries(fieldErrorMap).forEach(([fieldId, errorId]) => {
      const input = document.getElementById(fieldId);
      if (input) {
        input.addEventListener('input', () => {
          clearError(fieldId, errorId);
        });
      }
    });

    // Store form data for verification step
    let pendingRegistration = null;
    let verificationTimer = null;
    let timerSeconds = 900; // 15 minutes
    let validatedPromoCode = null; // Store validated promo code

    // Promo Code Validation
    const promoCodeInput = document.getElementById('promoCode');
    const validatePromoBtn = document.getElementById('validatePromoBtn');
    const promoCodeError = document.getElementById('promoCodeError');
    const promoCodeResult = document.getElementById('promoCodeResult');
    const promoCodeMessage = document.getElementById('promoCodeMessage');

    validatePromoBtn.addEventListener('click', async () => {
      const code = promoCodeInput.value.trim().toUpperCase();

      if (!code) {
        promoCodeError.textContent = 'Please enter a promo code';
        promoCodeResult.style.display = 'none';
        validatedPromoCode = null;
        return;
      }

      // Clear previous state
      promoCodeError.textContent = '';
      promoCodeResult.style.display = 'none';

      // Show loading
      validatePromoBtn.disabled = true;
      validatePromoBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Validating...';

      try {
        const result = await api.validatePromoCode(code);

        if (result.valid) {
          validatedPromoCode = result.code;
          promoCodeResult.style.display = 'block';
          promoCodeMessage.textContent = result.message || result.discount_display;
          promoCodeInput.classList.add('success');
          promoCodeInput.classList.remove('error');
          Toast.success('Promo code applied!');
        } else {
          validatedPromoCode = null;
          promoCodeError.textContent = result.message || 'Invalid promo code';
          promoCodeInput.classList.add('error');
          promoCodeInput.classList.remove('success');
        }
      } catch (error) {
        console.error('Promo validation error:', error);
        validatedPromoCode = null;
        promoCodeError.textContent = error.message || 'Failed to validate promo code';
        promoCodeInput.classList.add('error');
        promoCodeInput.classList.remove('success');
      } finally {
        validatePromoBtn.disabled = false;
        validatePromoBtn.innerHTML = '<i class="fas fa-check"></i> Apply';
      }
    });

    // Clear promo validation when input changes
    promoCodeInput.addEventListener('input', () => {
      promoCodeError.textContent = '';
      promoCodeInput.classList.remove('error', 'success');
      promoCodeResult.style.display = 'none';
      validatedPromoCode = null;
    });

    // Verification Modal Elements
    const verificationModal = document.getElementById('verificationModal');
    const closeModal = document.getElementById('closeModal');
    const codeInputs = document.querySelectorAll('.code-input');
    const verifyBtn = document.getElementById('verifyBtn');
    const resendCode = document.getElementById('resendCode');
    const timerDisplay = document.getElementById('timerDisplay');
    const verificationError = document.getElementById('verificationError');
    const verificationSuccess = document.getElementById('verificationSuccess');
    const verificationEmailSpan = document.getElementById('verificationEmail');

    // Open verification modal
    function openVerificationModal(email) {
      verificationEmailSpan.textContent = email;
      verificationModal.classList.add('active');
      codeInputs[0].focus();
      startTimer();
    }

    // Close verification modal
    function closeVerificationModal() {
      verificationModal.classList.remove('active');
      stopTimer();
      clearCodeInputs();
      hideVerificationMessages();
    }

    closeModal.addEventListener('click', closeVerificationModal);

    // Timer functions
    function startTimer() {
      timerSeconds = 900; // 15 minutes
      updateTimerDisplay();
      verificationTimer = setInterval(() => {
        timerSeconds--;
        updateTimerDisplay();
        if (timerSeconds <= 0) {
          stopTimer();
          showVerificationError('Code has expired. Please request a new one.');
        }
      }, 1000);
    }

    function stopTimer() {
      if (verificationTimer) {
        clearInterval(verificationTimer);
        verificationTimer = null;
      }
    }

    function updateTimerDisplay() {
      const minutes = Math.floor(timerSeconds / 60);
      const seconds = timerSeconds % 60;
      timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    // Code input handling
    codeInputs.forEach((input, index) => {
      input.addEventListener('input', (e) => {
        const value = e.target.value.replace(/[^0-9]/g, '');
        e.target.value = value;

        if (value && index < 5) {
          codeInputs[index + 1].focus();
        }

        // Auto-submit when all filled
        if (getCode().length === 6) {
          verifyAndRegister();
        }
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !e.target.value && index > 0) {
          codeInputs[index - 1].focus();
        }
      });

      // Handle paste
      input.addEventListener('paste', (e) => {
        e.preventDefault();
        const pastedData = e.clipboardData.getData('text').replace(/[^0-9]/g, '').slice(0, 6);
        pastedData.split('').forEach((char, i) => {
          if (codeInputs[i]) {
            codeInputs[i].value = char;
          }
        });
        if (pastedData.length === 6) {
          verifyAndRegister();
        }
      });
    });

    function getCode() {
      return Array.from(codeInputs).map(input => input.value).join('');
    }

    function clearCodeInputs() {
      codeInputs.forEach(input => {
        input.value = '';
        input.classList.remove('error', 'success');
      });
    }

    function showVerificationError(message) {
      verificationError.textContent = message;
      verificationError.style.display = 'block';
      verificationSuccess.style.display = 'none';
      codeInputs.forEach(input => input.classList.add('error'));
    }

    function showVerificationSuccess(message) {
      verificationSuccess.textContent = message;
      verificationSuccess.style.display = 'block';
      verificationError.style.display = 'none';
      codeInputs.forEach(input => {
        input.classList.remove('error');
        input.classList.add('success');
      });
    }

    function hideVerificationMessages() {
      verificationError.style.display = 'none';
      verificationSuccess.style.display = 'none';
    }

    // Verify and Register
    async function verifyAndRegister() {
      const code = getCode();
      if (code.length !== 6) {
        showVerificationError('Please enter the complete 6-digit code');
        return;
      }

      hideVerificationMessages();
      showLoading(verifyBtn);

      try {
        // First verify the email
        await api.verifyEmail(pendingRegistration.email, code);

        showVerificationSuccess('Email verified! Creating your account...');

        // Then complete registration
        const registrationData = {
          email: pendingRegistration.email,
          password: pendingRegistration.password,
          verification_code: code,
          role: 'student',
          first_name: pendingRegistration.firstName,
          last_name: pendingRegistration.lastName,
          phone: pendingRegistration.phone,
          student_class: pendingRegistration.studentClass
        };

        // Include promo code if validated
        if (pendingRegistration.promoCode) {
          registrationData.promo_code = pendingRegistration.promoCode;
        }

        const result = await api.registerWithVerification(registrationData);

        showVerificationSuccess('Account created successfully!');

        // Show appropriate success message
        if (result.promo_applied) {
          Toast.success(`Account created with ${result.promo_applied.discount_display}! Redirecting...`);
        } else {
          Toast.success('Account created! Redirecting to login...');
        }

        setTimeout(() => {
          window.location.href = 'login.html';
        }, 1500);

      } catch (error) {
        console.error('Verification error:', error);
        showVerificationError(error.message || 'Verification failed. Please try again.');
        hideLoading(verifyBtn);
      }
    }

    verifyBtn.addEventListener('click', verifyAndRegister);

    // Resend code
    let resendCooldown = 0;
    resendCode.addEventListener('click', async () => {
      if (resendCooldown > 0) return;

      try {
        resendCode.classList.add('disabled');
        resendCode.textContent = 'Sending...';

        await api.resendVerificationCode(pendingRegistration.email);

        Toast.success('New verification code sent!');
        timerSeconds = 900;
        startTimer();
        clearCodeInputs();
        hideVerificationMessages();
        codeInputs[0].focus();

        // Cooldown for resend (60 seconds)
        resendCooldown = 60;
        const cooldownInterval = setInterval(() => {
          resendCooldown--;
          resendCode.textContent = `Resend in ${resendCooldown}s`;
          if (resendCooldown <= 0) {
            clearInterval(cooldownInterval);
            resendCode.classList.remove('disabled');
            resendCode.textContent = 'Resend Code';
          }
        }, 1000);

      } catch (error) {
        console.error('Resend error:', error);
        Toast.error(error.message || 'Failed to resend code');
        resendCode.classList.remove('disabled');
        resendCode.textContent = 'Resend Code';
      }
    });

    // Form submission - Step 1: Validate and send verification code
    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Get values
      const firstName = document.getElementById('firstName').value.trim();
      const lastName = document.getElementById('lastName').value.trim();
      const studentEmail = document.getElementById('studentEmail').value.trim();
      const studentPhone = document.getElementById('studentPhone').value.trim();
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const parentName = document.getElementById('parentName').value.trim();
      const parentEmail = document.getElementById('parentEmail').value.trim();
      const parentPhone = document.getElementById('parentPhone').value.trim();
      const acceptTerms = document.getElementById('acceptTerms').checked;

      let isValid = true;

      // Validate first name
      if (!firstName) {
        showError('firstName', 'firstNameError', 'First name is required');
        isValid = false;
      }

      // Validate last name
      if (!lastName) {
        showError('lastName', 'lastNameError', 'Last name is required');
        isValid = false;
      }

      // Validate student email
      if (!validateEmail(studentEmail)) {
        showError('studentEmail', 'studentEmailError', 'Please enter a valid email');
        isValid = false;
      }

      // Validate student phone
      if (!validatePhone(studentPhone)) {
        showError('studentPhone', 'studentPhoneError', 'Enter valid 10-digit mobile number');
        isValid = false;
      }

      // Validate password
      if (password.length < 8) {
        showError('password', 'passwordError', 'Password must be at least 8 characters');
        isValid = false;
      }

      // Validate confirm password
      if (password !== confirmPassword) {
        showError('confirmPassword', 'confirmPasswordError', 'Passwords do not match');
        isValid = false;
      }

      // Validate parent name
      if (!parentName) {
        showError('parentName', 'parentNameError', 'Parent/Guardian name is required');
        isValid = false;
      }

      // Validate parent email
      if (!validateEmail(parentEmail)) {
        showError('parentEmail', 'parentEmailError', 'Please enter a valid email');
        isValid = false;
      }

      // Validate parent phone
      if (!validatePhone(parentPhone)) {
        showError('parentPhone', 'parentPhoneError', 'Enter valid 10-digit mobile number');
        isValid = false;
      }

      // Validate terms acceptance
      if (!acceptTerms) {
        document.getElementById('termsError').textContent = 'You must accept the Terms and Conditions';
        isValid = false;
      } else {
        document.getElementById('termsError').textContent = '';
      }

      if (!isValid) return;

      // Store pending registration data
      pendingRegistration = {
        email: studentEmail,
        password: password,
        firstName: firstName,
        lastName: lastName,
        phone: studentPhone,
        studentClass: selectedClass,
        promoCode: validatedPromoCode // Include validated promo code
      };

      // Show loading state
      showLoading(registerBtn);

      try {
        // Send verification code
        await api.sendVerificationCode(studentEmail, firstName, 'registration');

        Toast.success('Verification code sent to your email!');
        hideLoading(registerBtn);

        // Open verification modal
        openVerificationModal(studentEmail);

      } catch (error) {
        console.error('Send verification error:', error);
        Toast.error(error.message || 'Failed to send verification code. Please try again.');
        hideLoading(registerBtn);
      }
    });

    // Check if user is already logged in
    if (isAuthenticated()) {
      const role = getUserRole();
      switch (role) {
        case 'student':
          window.location.href = 'student/dashboard.html';
          break;
        case 'teacher':
          window.location.href = 'teacher/dashboard.html';
          break;
        case 'admin':
          window.location.href = 'admin/dashboard.html';
          break;
      }
    }
  </script>
</body>
</html>
